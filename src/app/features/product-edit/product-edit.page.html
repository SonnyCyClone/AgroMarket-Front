<!--
  P√°gina de edici√≥n de producto - AgroMarket
  
  Template completo para editar productos con dise√±o por secciones,
  todos los campos del contrato PUT API y funcionalidad de imagen.
-->

<div class="edit-product-container">
  
  <!-- Header de la p√°gina -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <button 
          id="btn-back-to-manage"
          type="button" 
          class="btn-back"
          (click)="goBack()"
          aria-label="Volver a gesti√≥n de productos">
          <span class="back-icon">‚Üê</span>
        </button>
        <div class="title-section">
          <h1 id="page-title" class="page-title">
            <span class="title-icon">‚úèÔ∏è</span>
            Editar Producto
          </h1>
          @if (product()) {
            <p class="page-subtitle">
              Editando: {{ product()?.variedad }}
            </p>
          }
        </div>
      </div>
      <div class="header-right">
        @if (productId()) {
          <span class="product-id">ID: {{ productId() }}</span>
        }
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="page-content">
    
    <!-- Loading state -->
    @if (isLoading()) {
      <div class="loading-container">
        <div class="loading-spinner-large"></div>
        <p>Cargando producto...</p>
      </div>
    }

    <!-- Error state -->
    @if (showError() && !isLoading()) {
      <div class="error-container">
        <div class="error-message-large" role="alert">
          <span class="error-icon">‚ö†</span>
          {{ showError() }}
        </div>
      </div>
    }

    <!-- Success message -->
    @if (showMessage()) {
      <div class="success-message-large" role="alert">
        <span class="success-icon">‚úì</span>
        {{ showMessage() }}
      </div>
    }

    <!-- Formulario -->
    @if (editForm && product() && !isLoading()) {
      <form [formGroup]="editForm" (ngSubmit)="onSubmit()" class="edit-form">
        
        <!-- Grid de secciones responsive -->
        <div class="form-grid">
          
          <!-- Secci√≥n: Informaci√≥n B√°sica -->
          <div class="form-section">
            <h2 class="section-title">
              <span class="section-icon">üìù</span>
              Informaci√≥n B√°sica
            </h2>
            
            <div class="section-content">
              <!-- Campo Variedad -->
              <div class="form-group">
                <label for="variedad-edit-page" class="form-label">
                  Variedad <span class="required">*</span>
                </label>
                <input
                  id="variedad-edit-page"
                  type="text"
                  class="form-input"
                  [class.error]="hasFieldError('variedad')"
                  formControlName="variedad"
                  placeholder="Ej: Tomate cherry, Lechuga romana..."
                  maxlength="100"
                  autocomplete="off">
                @if (hasFieldError('variedad')) {
                  <div class="error-message" role="alert">
                    {{ getFieldError('variedad') }}
                  </div>
                }
              </div>

              <!-- Campo Descripci√≥n -->
              <div class="form-group">
                <label for="descripcion-edit-page" class="form-label">
                  Descripci√≥n <span class="required">*</span>
                </label>
                <textarea
                  id="descripcion-edit-page"
                  class="form-textarea"
                  [class.error]="hasFieldError('descripcion')"
                  formControlName="descripcion"
                  placeholder="Describe las caracter√≠sticas de tu producto..."
                  rows="4"
                  maxlength="500">
                </textarea>
                <div class="char-counter">
                  {{ editForm.get('descripcion')?.value?.length || 0 }}/500
                </div>
                @if (hasFieldError('descripcion')) {
                  <div class="error-message" role="alert">
                    {{ getFieldError('descripcion') }}
                  </div>
                }
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Inventario y Precio -->
          <div class="form-section">
            <h2 class="section-title">
              <span class="section-icon">üí∞</span>
              Inventario y Precio
            </h2>
            
            <div class="section-content">
              <!-- Fila de precio y cantidad -->
              <div class="form-row">
                <!-- Campo Precio -->
                <div class="form-group">
                  <label for="precio-edit-page" class="form-label">
                    Precio <span class="required">*</span>
                  </label>
                  <div class="price-input-container">
                    <span class="currency-indicator">COP $</span>
                    <input
                      id="precio-edit-page"
                      type="number"
                      class="form-input price-input"
                      [class.error]="hasFieldError('precio')"
                      formControlName="precio"
                      placeholder="0"
                      min="0"
                      step="100">
                  </div>
                  @if (hasFieldError('precio')) {
                    <div class="error-message" role="alert">
                      {{ getFieldError('precio') }}
                    </div>
                  }
                </div>

                <!-- Campo Cantidad -->
                <div class="form-group">
                  <label for="cantidad-edit-page" class="form-label">
                    Cantidad Disponible <span class="required">*</span>
                  </label>
                  <input
                    id="cantidad-edit-page"
                    type="number"
                    class="form-input"
                    [class.error]="hasFieldError('cantidadDisponible')"
                    formControlName="cantidadDisponible"
                    placeholder="0"
                    min="0"
                    step="1">
                  @if (hasFieldError('cantidadDisponible')) {
                    <div class="error-message" role="alert">
                      {{ getFieldError('cantidadDisponible') }}
                    </div>
                  }
                </div>
              </div>

              <!-- Campo Unidad de Medida -->
              <div class="form-group">
                <label for="unidades-edit-page" class="form-label">
                  Unidad de Medida <span class="required">*</span>
                </label>
                <select
                  id="unidades-edit-page"
                  class="form-select"
                  [class.error]="hasFieldError('unidadesId')"
                  formControlName="unidadesId">
                  <option value="">Selecciona una unidad</option>
                  @for (unidad of unidades(); track unidad.id) {
                    <option [value]="unidad.id">
                      {{ unidad.nombre }} ({{ unidad.abreviatura }})
                    </option>
                  }
                </select>
                @if (hasFieldError('unidadesId')) {
                  <div class="error-message" role="alert">
                    {{ getFieldError('unidadesId') }}
                  </div>
                }
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Clasificaci√≥n -->
          <div class="form-section">
            <h2 class="section-title">
              <span class="section-icon">üè∑Ô∏è</span>
              Clasificaci√≥n
            </h2>
            
            <div class="section-content">
              <!-- Campo Categor√≠a (para filtrar tipos) -->
              <div class="form-group">
                <label for="categoria-filter-page" class="form-label">
                  Categor√≠a
                </label>
                <select
                  id="categoria-filter-page"
                  class="form-select"
                  [value]="selectedCategoriaId()"
                  (change)="onCategoriaChange(+$any($event.target).value)">
                  <option value="">Selecciona una categor√≠a</option>
                  @for (categoria of categorias(); track categoria.id) {
                    <option [value]="categoria.id">
                      {{ categoria.nombre }}
                    </option>
                  }
                </select>
                <small class="help-text">
                  Selecciona la categor√≠a para filtrar los tipos de producto
                </small>
              </div>

              <!-- Campo Tipo de Producto -->
              <div class="form-group">
                <label for="tipo-producto-edit-page" class="form-label">
                  Tipo de Producto <span class="required">*</span>
                </label>
                <select
                  id="tipo-producto-edit-page"
                  class="form-select"
                  [class.error]="hasFieldError('idTipoProducto')"
                  formControlName="idTipoProducto">
                  <option value="">Selecciona un tipo</option>
                  @for (tipo of tiposProducto(); track tipo.id) {
                    <option [value]="tipo.id">
                      {{ tipo.nombre }}
                    </option>
                  }
                </select>
                @if (hasFieldError('idTipoProducto')) {
                  <div class="error-message" role="alert">
                    {{ getFieldError('idTipoProducto') }}
                  </div>
                }
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Imagen -->
          <div class="form-section">
            <h2 class="section-title">
              <span class="section-icon">üñºÔ∏è</span>
              Imagen del Producto
            </h2>
            
            <div class="section-content">
              <!-- Preview de imagen -->
              @if (imagePreview()) {
                <div class="image-preview-container">
                  <img [src]="imagePreview()" alt="Preview del producto" class="image-preview">
                  <button 
                    id="btn-remove-image-edit"
                    type="button" 
                    class="remove-image-btn" 
                    (click)="removeImage()" 
                    title="Remover imagen"
                    aria-label="Remover imagen">
                    <span class="remove-icon">üóëÔ∏è</span>
                  </button>
                </div>
              }

              <!-- Upload de imagen -->
              <div class="image-upload-area" [class.has-image]="imagePreview()">
                <input
                  type="file"
                  id="image-upload-edit"
                  accept="image/*"
                  (change)="onImageFileSelected($event)"
                  class="file-input">
                <label for="image-upload-edit" class="file-label">
                  <span class="upload-icon">üìÅ</span>
                  <span class="upload-text">
                    {{ imagePreview() ? 'Cambiar imagen' : 'Seleccionar imagen' }}
                  </span>
                  <small class="upload-hint">JPG, PNG hasta 5MB</small>
                </label>
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Estado -->
          <div class="form-section">
            <h2 class="section-title">
              <span class="section-icon">‚öôÔ∏è</span>
              Estado
            </h2>
            
            <div class="section-content">
              <!-- Campo Activo -->
              <div class="form-group">
                <div class="checkbox-group">
                  <label class="checkbox-label">
                    <input
                      id="activo-edit-page"
                      type="checkbox"
                      class="checkbox-input"
                      formControlName="activo">
                    <span class="checkbox-custom"></span>
                    <span class="checkbox-text">Producto activo</span>
                  </label>
                  <small class="help-text">
                    Si est√° marcado, el producto ser√° visible para los compradores
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Informaci√≥n del Sistema -->
          @if (product()) {
            <div class="form-section info-section">
              <h2 class="section-title">
                <span class="section-icon">‚ÑπÔ∏è</span>
                Informaci√≥n del Sistema
              </h2>
              
              <div class="section-content">
                <div class="info-grid">
                  <div class="info-item">
                    <strong class="info-label">ID del producto:</strong>
                    <span class="info-value">{{ product()?.id }}</span>
                  </div>
                  <div class="info-item">
                    <strong class="info-label">Fecha de creaci√≥n:</strong>
                    <span class="info-value">{{ product()?.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  @if (product()?.fechaActualizacion) {
                    <div class="info-item">
                      <strong class="info-label">√öltima actualizaci√≥n:</strong>
                      <span class="info-value">{{ product()?.fechaActualizacion | date:'dd/MM/yyyy HH:mm' }}</span>
                    </div>
                  }
                </div>
              </div>
            </div>
          }

        </div>

        <!-- Botones de acci√≥n fijos -->
        <div class="form-actions-fixed">
          <div class="actions-container">
            <button 
              id="btn-cancel-edit"
              type="button" 
              class="btn btn-secondary"
              (click)="goBack()"
              [disabled]="isSubmitting()">
              <span class="btn-icon">‚ùå</span>
              Cancelar
            </button>
            <button 
              id="btn-save-edit"
              type="submit" 
              class="btn btn-primary"
              [disabled]="!editForm.valid || isSubmitting()">
              @if (isSubmitting()) {
                <span class="loading-spinner"></span>
                Guardando...
              } @else {
                <span class="btn-icon">üíæ</span>
                Guardar Cambios
              }
            </button>
          </div>
          
          <!-- Indicador de campos obligatorios -->
          <div class="required-notice">
            <span class="required">*</span> Campos obligatorios
          </div>
        </div>

      </form>
    }
  </div>
</div>