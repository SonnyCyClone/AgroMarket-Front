<!-- Mensajes de √©xito y error -->
<div class="message-container">
  <!-- Mensaje de √©xito -->
  <div *ngIf="showSuccessMessage" class="success-message" role="alert">
    <div class="message-content">
      <div class="message-icon">‚úÖ</div>
      <div class="message-text">{{ successMessage }}</div>
      <button 
        type="button" 
        class="message-close"
        (click)="dismissSuccessMessage()"
        aria-label="Cerrar mensaje de √©xito">
        ‚úï
      </button>
    </div>
  </div>

  <!-- Banner de error -->
  <div *ngIf="showErrorMessage" class="error-message-banner" role="alert">
    <div class="message-content">
      <div class="message-icon">‚ö†Ô∏è</div>
      <div class="message-text">{{ errorMessage }}</div>
      <button 
        type="button" 
        class="message-close"
        (click)="dismissErrorMessage()"
        aria-label="Cerrar mensaje de error">
        ‚úï
      </button>
    </div>
  </div>
</div>

<!-- Contenedor principal -->
<div class="register-product-container">
  <header class="page-header">
    <h1>Registrar Nuevo Producto</h1>
    <p>Complete el formulario para agregar un producto a su inventario</p>
  </header>

  <!-- Indicador de carga -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando datos del formulario...</p>
  </div>

  <!-- Formulario -->
  <form *ngIf="!isLoading" [formGroup]="productForm" (ngSubmit)="onSubmit()" class="product-form">
    
    <!-- Informaci√≥n b√°sica -->
    <section class="form-section">
      <h2>Informaci√≥n B√°sica</h2>
      
      <!-- Variedad -->
      <div class="form-group">
        <label for="variedad">Variedad del Producto *</label>
        <input
          id="variedad"
          type="text"
          formControlName="variedad"
          placeholder="Ej: Tomate Cherry, Ma√≠z Amarillo, Yuca Criolla"
          [class.error]="getFieldError('variedad')"
          maxlength="100">
        <small class="helper-text">Especifica la variedad espec√≠fica de tu producto (m√°ximo 100 caracteres)</small>
        <div *ngIf="getFieldError('variedad')" class="error-message">
          {{ getFieldError('variedad') }}
        </div>
      </div>

      <!-- Descripci√≥n -->
      <div class="form-group">
        <label for="descripcion">Descripci√≥n *</label>
        <textarea
          id="descripcion"
          formControlName="descripcion"
          placeholder="Describe las caracter√≠sticas del producto: calidad, m√©todo de cultivo, origen, etc."
          [class.error]="getFieldError('descripcion')"
          maxlength="500"
          rows="4">
        </textarea>
        <small class="helper-text">Incluye informaci√≥n sobre calidad, m√©todo de cultivo, origen (m√°ximo 500 caracteres)</small>
        <div *ngIf="getFieldError('descripcion')" class="error-message">
          {{ getFieldError('descripcion') }}
        </div>
      </div>
    </section>

    <!-- Precio y cantidades -->
    <section class="form-section">
      <h2>Precio y Disponibilidad</h2>
      
      <div class="form-row">
        <!-- Precio con selector de moneda embebido -->
        <div class="form-group">
          <label for="precio">Precio de Venta *</label>
          <div class="price-input-group">
            <select 
              id="moneda-selector"
              formControlName="moneda" 
              class="currency-selector"
              aria-label="Selector de moneda">
              <option *ngFor="let moneda of monedas" [value]="moneda.codigo">
                {{ moneda.codigo }}
              </option>
            </select>
            <input
              id="precio"
              type="number"
              formControlName="precio"
              class="price-input"
              placeholder="0.00"
              [class.error]="getFieldError('precio')"
              min="0.01"
              step="0.01"
              aria-describedby="precio-help precio-preview">
          </div>
          <small id="precio-help" class="helper-text">Precio por unidad de medida en la moneda seleccionada</small>
          <div *ngIf="getFieldError('precio')" class="error-message">
            {{ getFieldError('precio') }}
          </div>
          <div *ngIf="productForm.get('precio')?.value > 0" id="precio-preview" class="price-preview">
            Vista previa: {{ formatPrice(productForm.get('precio')?.value) }}
          </div>
        </div>

        <!-- Cantidad disponible -->
        <div class="form-group">
          <label for="cantidad-disponible">Cantidad Disponible *</label>
          <input
            id="cantidad-disponible"
            type="number"
            formControlName="cantidadDisponible"
            placeholder="0"
            [class.error]="getFieldError('cantidadDisponible')"
            min="1">
          <small class="helper-text">Cantidad que tienes disponible para vender</small>
          <div *ngIf="getFieldError('cantidadDisponible')" class="error-message">
            {{ getFieldError('cantidadDisponible') }}
          </div>
        </div>
      </div>

      <!-- Unidad de medida -->
      <div class="form-group">
        <label for="unidades-select">Unidad de Medida *</label>
        <select
          id="unidades-select"
          formControlName="unidadesId"
          [class.error]="getFieldError('unidadesId')">
          <option value="">Selecciona una unidad de medida</option>
          <option *ngFor="let unidad of unidades" [value]="unidad.id">
            {{ formatUnidadOption(unidad) }}
          </option>
        </select>
        <small class="helper-text">C√≥mo se mide tu producto (kilogramos, libras, unidades, etc.)</small>
        <div *ngIf="getFieldError('unidadesId')" class="error-message">
          {{ getFieldError('unidadesId') }}
        </div>
      </div>
    </section>

    <!-- Categorizaci√≥n -->
    <section class="form-section">
      <h2>Categorizaci√≥n</h2>
      
      <div class="form-row">
        <!-- Categor√≠a -->
        <div class="form-group">
          <label for="categoria-select">Categor√≠a *</label>
          <div class="select-with-action">
            <select
              id="categoria-select"
              formControlName="categoriaId"
              [class.error]="getFieldError('categoriaId')">
              <option value="">Selecciona una categor√≠a</option>
              <option *ngFor="let categoria of categorias" [value]="categoria.id">
                {{ categoria.nombre }}
              </option>
            </select>
          </div>
          <small class="helper-text">Tipo general de producto (frutas, verduras, granos, etc.)</small>
          <div *ngIf="getFieldError('categoriaId')" class="error-message">
            {{ getFieldError('categoriaId') }}
          </div>
        </div>

        <!-- Tipo de producto -->
        <div class="form-group">
          <label for="tipo-producto-select">Tipo de Producto *</label>
          <select
            id="tipo-producto-select"
            formControlName="idTipoProducto"
            [class.error]="getFieldError('idTipoProducto')"
            [disabled]="!productForm.get('categoriaId')?.value || isLoadingTipos">
            <option value="">
              {{ !productForm.get('categoriaId')?.value ? 'Primero selecciona una categor√≠a' : 
                 isLoadingTipos ? 'Cargando...' : 'Selecciona un tipo de producto' }}
            </option>
            <option *ngFor="let tipo of tiposProducto" [value]="tipo.id">
              {{ tipo.nombre }}
            </option>
          </select>
          <small class="helper-text">Tipo espec√≠fico dentro de la categor√≠a seleccionada</small>
          <div *ngIf="getFieldError('idTipoProducto')" class="error-message">
            {{ getFieldError('idTipoProducto') }}
          </div>
        </div>
      </div>
    </section>

    <!-- Imagen del producto -->
    <section class="form-section">
      <h2>Imagen del Producto</h2>
      
      <div class="image-upload-container">
        <!-- √Årea de drag & drop -->
        <div 
          class="image-drop-area"
          [class.has-image]="imagePreviewUrl"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onImageDrop($event)">
          
          <!-- Preview de imagen -->
          <div *ngIf="imagePreviewUrl" class="image-preview">
            <img [src]="imagePreviewUrl" alt="Vista previa del producto">
            <button 
              id="remove-image-btn"
              type="button" 
              class="remove-image-btn"
              (click)="onImageRemoved()"
              aria-label="Eliminar imagen">
              ‚úï
            </button>
          </div>
          
          <!-- √Årea de carga -->
          <div *ngIf="!imagePreviewUrl" class="upload-placeholder">
            <div class="upload-icon">üì∑</div>
            <p class="upload-text">Arrastra una imagen aqu√≠ o</p>
            <label for="image-input" class="upload-button">
              Seleccionar Imagen
            </label>
            <input 
              id="image-input"
              type="file"
              accept="image/*"
              (change)="onImageSelected($event)"
              style="display: none;">
          </div>
        </div>
        
        <small class="helper-text">
          Formatos aceptados: JPG, PNG, GIF. Tama√±o m√°ximo: 5MB
        </small>
      </div>
    </section>

    <!-- Configuraci√≥n adicional -->
    <section class="form-section">
      <h2>Configuraci√≥n</h2>
      
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input 
            id="producto-activo"
            type="checkbox" 
            formControlName="activo"
            class="checkbox-input">
          <span class="checkbox-custom"></span>
          Producto activo y disponible para venta
        </label>
        <small class="helper-text">Los productos inactivos no aparecer√°n en el cat√°logo p√∫blico</small>
      </div>
    </section>

    <!-- Botones de acci√≥n -->
    <div class="form-actions">
      <button 
        id="cancel-btn"
        type="button" 
        class="btn btn-secondary"
        (click)="router.navigate(['/products/manage'])">
        Cancelar
      </button>
      
      <button 
        id="submit-btn"
        type="submit" 
        class="btn btn-primary"
        [disabled]="productForm.invalid || isSubmitting">
        <span *ngIf="isSubmitting" class="spinner-small"></span>
        {{ isSubmitting ? 'Registrando...' : 'Registrar Producto' }}
      </button>
    </div>
  </form>
</div>